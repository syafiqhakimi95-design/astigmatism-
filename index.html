<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cikgu Astig Pro</title>
    <style>
        :root { --primary: #0f766e; --accent: #0ea5e9; --bg: #f0fdfa; --text: #134e4a; --card: #ffffff; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- NAVIGATION --- */
        .header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; }
        .header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: none; } /* Hidden on home */

        /* --- PAGES --- */
        .page { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .page.active { display: flex; flex-direction: column; gap: 15px; }

        /* --- HOME DASHBOARD --- */
        .menu-grid { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 10px; }
        .menu-card {
            background: var(--card); border: 1px solid #ccfbf1; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; gap: 15px;
        }
        .menu-card:active { transform: scale(0.98); background: #f0fdfa; }
        .menu-icon { width: 50px; height: 50px; background: #e0f2fe; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent); }
        .menu-text h3 { margin: 0 0 5px 0; color: var(--primary); font-size: 1rem; }
        .menu-text p { margin: 0; font-size: 0.8rem; color: #64748b; }

        /* --- COMMON UI --- */
        .card { background: var(--card); padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 10px; }
        input[type=range] { width: 100%; accent-color: var(--accent); }
        input[type=number] { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 60px; text-align: center; }
        select { padding: 8px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; }
        
        .result-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; color: var(--primary); margin-top: 10px; border: 1px dashed #cbd5e1; }

        /* --- CANVAS STYLES --- */
        canvas { width: 100%; height: 200px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }

        /* --- PAGE 3 SPECIFIC --- */
        .split-view { display: flex; gap: 10px; height: 180px; }
        .split-left { flex: 2; position: relative; } /* Ray View */
        .split-right { flex: 1; background: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; } /* Patient View */
        .patient-img { font-size: 80px; color: white; font-family: serif; filter: blur(0px); transition: filter 0.1s; }
        .blur-label { position: absolute; bottom: 5px; right: 5px; color: #ef4444; font-size: 0.7rem; font-weight: bold; background: rgba(0,0,0,0.5); padding: 2px 6px; border-radius: 4px; }

    </style>
</head>
<body>

    <div class="header">
        <button id="btnBack" class="back-btn">‚Üê Back</button>
        <h1 id="pageTitle">Cikgu Astig Pro</h1>
        <div style="width:50px;"></div> </div>

    <div id="pageHome" class="page active">
        <div class="menu-grid">
            <div class="menu-card" onclick="nav('pageTransposition', 'Rx Calculator')">
                <div class="menu-icon">üßÆ</div>
                <div class="menu-text">
                    <h3>Transposition & SE</h3>
                    <p>Optical cross calculator & Spherical Equivalent</p>
                </div>
            </div>
            <div class="menu-card" onclick="nav('pageRay', 'Astigmatism Types')">
                <div class="menu-icon">üëÅÔ∏è</div>
                <div class="menu-text">
                    <h3>Ray Diagram</h3>
                    <p>Visualize Focal Lines & Classify Astigmatism</p>
                </div>
            </div>
            <div class="menu-card" onclick="nav('pageSturm', 'Interval of Sturm')">
                <div class="menu-icon">üéØ</div>
                <div class="menu-text">
                    <h3>Interval of Sturm</h3>
                    <p>Collapse the conoid & Simulate Vision</p>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-top:auto;">
            <h3>Patient Profile (Global)</h3>
            <div class="control-row">
                <label>Age:</label>
                <input type="number" id="globalAge" value="25">
            </div>
            <small style="color:#64748b;">Settings persist across labs.</small>
        </div>
    </div>

    <div id="pageTransposition" class="page">
        <div class="card">
            <h3>Input Prescription</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="number" id="rxSph" placeholder="Sph" value="-2.00" step="0.25">
                <input type="number" id="rxCyl" placeholder="Cyl" value="-1.50" step="0.25">
                <input type="number" id="rxAxis" placeholder="Axis" value="180" step="1">
            </div>
            <button onclick="calcTransposition()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:6px;">Calculate</button>
        </div>

        <div class="card">
            <h3>Results</h3>
            <div class="result-box">
                <div id="transposedRx" style="font-size:1.1rem;">-3.50 / +1.50 x 90</div>
                <div style="font-size:0.8rem; color:#64748b; margin-top:5px;">(Transposed Form)</div>
            </div>
            <div class="result-box" style="background:#f0fdfa; border-color:#99f6e4;">
                <div id="seVal">SE: -2.75 D</div>
            </div>
        </div>

        <div class="card" style="flex:1;">
            <h3>Optical Cross</h3>
            <canvas id="canvasCross"></canvas>
        </div>
    </div>

    <div id="pageRay" class="page">
        <canvas id="canvasRay" style="height:220px;"></canvas>
        
        <div class="result-box" id="astigType">Compound Myopic Astigmatism</div>

        <div class="card">
            <h3>Refractive Components</h3>
            
            <div class="control-row">
                <label>Sphere (Red Line)</label>
                <span id="valSphRay" style="font-weight:bold; color:#dc2626;">-2.00 D</span>
            </div>
            <input type="range" id="sliderSphRay" min="-6" max="6" step="0.25" value="-2.00">

            <div class="control-row" style="margin-top:15px;">
                <label>Cylinder (Gap)</label>
                <span id="valCylRay" style="font-weight:bold; color:#2563eb;">-2.00 D</span>
            </div>
            <input type="range" id="sliderCylRay" min="-4" max="0" step="0.25" value="-2.00">
            
            <div style="font-size:0.75rem; color:#64748b; margin-top:5px;">
                <span style="color:#dc2626;">‚óè Vertical Focus</span> vs <span style="color:#2563eb;">‚óè Horizontal Focus</span>
            </div>
        </div>
    </div>

    <div id="pageSturm" class="page">
        <div class="split-view">
            <div class="split-left">
                <canvas id="canvasSturm" style="height:100%; border:none; border-right:1px solid #ddd;"></canvas>
                <div style="position:absolute; top:5px; left:5px; font-size:0.7rem; color:#666;">Conoid View</div>
            </div>
            <div class="split-right">
                <div id="patientView" class="patient-img">E</div>
                <div id="blurLabel" class="blur-label">Blur</div>
            </div>
        </div>

        <div class="card">
            <h3>Simulation Controls</h3>
            <p style="font-size:0.8rem; color:#64748b; margin-bottom:15px;">
                Patient has <b>-3.00 Cyl</b> Astigmatism. Add correcting cylinder to collapse the Interval of Sturm.
            </p>

            <div class="control-row">
                <label>Correcting Cyl (DC)</label>
                <span id="valCorr" style="font-weight:bold; color:#059669;">0.00</span>
            </div>
            <input type="range" id="sliderCorr" min="-4.00" max="0.00" step="0.25" value="0.00">
            
            <div class="result-box" id="sturmStatus" style="font-size:0.9rem;">
                Interval Gap: 3.00 D
            </div>
        </div>
    </div>
<script>
    // --- NAVIGATION LOGIC ---
    function nav(pageId, title) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        // Show target
        document.getElementById(pageId).classList.add('active');
        // Update Header
        document.getElementById('pageTitle').innerText = title;
        document.getElementById('btnBack').style.display = 'block';
        
        // Trigger renders if needed
        if(pageId === 'pageTransposition') calcTransposition();
        if(pageId === 'pageRay') updateRayDiagram();
        if(pageId === 'pageSturm') updateSturm();
    }

    document.getElementById('btnBack').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('pageHome').classList.add('active');
        document.getElementById('pageTitle').innerText = 'Cikgu Astig Pro';
        document.getElementById('btnBack').style.display = 'none';
    });

    // --- PAGE 1: TRANSPOSITION & OPTICAL CROSS ---
    function calcTransposition() {
        let s = parseFloat(document.getElementById('rxSph').value);
        let c = parseFloat(document.getElementById('rxCyl').value);
        let a = parseInt(document.getElementById('rxAxis').value);

        // 1. Transposition Logic (Minus to Plus or vice versa)
        let newS = s + c;
        let newC = -c;
        let newA = a > 90 ? a - 90 : a + 90;
        if (newA <= 0) newA += 180; // normalize

        // Display Transposed
        let sign = newC > 0 ? "+" : "";
        document.getElementById('transposedRx').innerText = 
            `${newS.toFixed(2)} / ${sign}${newC.toFixed(2)} x ${newA}`;

        // 2. Spherical Equivalent (SE)
        let se = s + (c / 2);
        document.getElementById('seVal').innerText = `SE: ${(se > 0 ? "+" : "")}${se.toFixed(2)} D`;

        // 3. Draw Optical Cross
        drawOpticalCross(s, c, a);
    }

    function drawOpticalCross(s, c, a) {
        const cvs = document.getElementById('canvasCross');
        const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2; // High DPI
        const h = cvs.height = cvs.clientHeight * 2;
        ctx.scale(2, 2); 
        const cx = w/4, cy = h/4; // Center (scaled back)

        ctx.clearRect(0, 0, w, h);
        ctx.strokeStyle = "#334155";
        ctx.lineWidth = 2;
        ctx.font = "14px Arial";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        // Powers in principle meridians
        // Power @ Axis = Sphere
        // Power @ 90 from Axis = Sphere + Cyl
        let pAxis = s; 
        let pperp = s + c;

        // Draw Cross
        ctx.beginPath();
        ctx.moveTo(cx, cy - 60); ctx.lineTo(cx, cy + 60); // Vertical
        ctx.moveTo(cx - 60, cy); ctx.lineTo(cx + 60, cy); // Horizontal
        ctx.stroke();

        // Labels
        // Simple logic for standard 90/180 cross visual
        // In a real cross, we rotate, but for basic calculation visualization:
        // We label the Vertical and Horizontal arms based on the axis input.
        
        let labelV, labelH;
        if (a === 180 || a === 0) {
            // Axis 180 -> Power @ 180 is S. Power @ 90 is S+C.
            // On cross: Horizontal arm is @180. Vertical is @90.
            labelH = pAxis.toFixed(2);
            labelV = pperp.toFixed(2);
        } else if (a === 90) {
            // Axis 90 -> Power @ 90 is S. Power @ 180 is S+C.
            labelV = pAxis.toFixed(2);
            labelH = pperp.toFixed(2);
        } else {
            // Oblique - Just show generic principal powers
            labelH = "Axis P: " + pAxis.toFixed(2);
            labelV = "Perp P: " + pperp.toFixed(2);
        }

        ctx.fillStyle = "#dc2626";
        ctx.fillText(labelV + " D", cx, cy - 75); // Top
        ctx.fillStyle = "#2563eb";
        ctx.fillText(labelH + " D", cx + 75, cy); // Right
    }

    // --- PAGE 2: RAY DIAGRAM (SIDE VIEW) ---
    const rayUi = {
        s: document.getElementById('sliderSphRay'),
        c: document.getElementById('sliderCylRay'),
        valS: document.getElementById('valSphRay'),
        valC: document.getElementById('valCylRay'),
        label: document.getElementById('astigType')
    };

    rayUi.s.addEventListener('input', updateRayDiagram);
    rayUi.c.addEventListener('input', updateRayDiagram);

    function updateRayDiagram() {
        let sph = parseFloat(rayUi.s.value);
        let cyl = parseFloat(rayUi.c.value);
        
        rayUi.valS.innerText = (sph>0?"+":"") + sph.toFixed(2) + " D";
        rayUi.valC.innerText = cyl.toFixed(2) + " D";

        // Logic:
        // Red Rays = Vertical Meridian = Sphere Power (Assuming Axis 180 WTR for demo)
        // Blue Rays = Horizontal Meridian = Sphere + Cyl
        
        let pRed = sph;
        let pBlue = sph + cyl;

        // Classification
        let type = "";
        // Retina is at 0 Diopters (Emmetropia)
        // Focus > 0 (In front, Myopic), Focus < 0 (Behind, Hyperopic)
        // Note: Power +2.00 focuses IN FRONT (Myopic shift). Power -2.00 focuses BEHIND (Hyperopic).
        // Let's map "Power" to "Focus Position relative to Retina".
        // + Power -> Front (Myopic). - Power -> Behind (Hyperopic).
        
        if (pRed > 0 && pBlue > 0) type = "Compound Myopic";
        else if (pRed < 0 && pBlue < 0) type = "Compound Hyperopic";
        else if ((pRed === 0 && pBlue !== 0) || (pRed !== 0 && pBlue === 0)) type = "Simple " + (pRed>0||pBlue>0 ? "Myopic" : "Hyperopic");
        else if (pRed === 0 && pBlue === 0) type = "Emmetropia";
        else type = "Mixed Astigmatism";

        rayUi.label.innerText = type;

        drawRayDiagram(pRed, pBlue);
    }

    function drawRayDiagram(pRed, pBlue) {
        const cvs = document.getElementById('canvasRay');
        const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2; 
        const h = cvs.height = cvs.clientHeight * 2; 
        ctx.scale(2, 2);
        ctx.clearRect(0,0,w,h);

        const cx = 50; const cy = 110; // Eye center
        const retinaX = 300; 

        // Draw Eye
        ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2);
        ctx.fillStyle = "white"; ctx.fill(); ctx.stroke();
        // Retina Line
        ctx.beginPath(); ctx.moveTo(retinaX, cy-50); ctx.lineTo(retinaX, cy+50);
        ctx.strokeStyle = "#333"; ctx.lineWidth = 2; ctx.stroke();
        ctx.fillStyle = "#333"; ctx.fillText("Retina", retinaX-20, cy-60);

        // Calculate Focus X
        // Base distance 250px (from 50 to 300).
        // Power 0 -> X = 300. 
        // Power +2 -> X = 200 (Short). Power -2 -> X = 400 (Long).
        // Scale factor: 1D = 30px shift approx?
        function getFocusX(p) {
            return retinaX - (p * 30);
        }

        let fxRed = getFocusX(pRed);
        let fxBlue = getFocusX(pBlue);

        // Draw Rays
        // Red (Vertical)
        ctx.beginPath(); ctx.strokeStyle = "rgba(220, 38, 38, 0.7)"; ctx.lineWidth = 2;
        ctx.moveTo(cx, cy-15); ctx.lineTo(fxRed, cy);
        ctx.moveTo(cx, cy+15); ctx.lineTo(fxRed, cy);
        ctx.stroke();

        // Blue (Horizontal)
        ctx.beginPath(); ctx.strokeStyle = "rgba(37, 99, 235, 0.7)"; ctx.lineWidth = 2;
        ctx.moveTo(cx, cy-10); ctx.lineTo(fxBlue, cy); // Slightly narrower start to differentiate
        ctx.moveTo(cx, cy+10); ctx.lineTo(fxBlue, cy);
        ctx.stroke();

        // Dots on focus
        ctx.beginPath(); ctx.fillStyle = "red"; ctx.arc(fxRed, cy, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.fillStyle = "blue"; ctx.arc(fxBlue, cy, 3, 0, Math.PI*2); ctx.fill();
    }

    // --- PAGE 3: INTERVAL OF STURM ---
    const sturmUi = {
        slider: document.getElementById('sliderCorr'),
        val: document.getElementById('valCorr'),
        status: document.getElementById('sturmStatus'),
        patientView: document.getElementById('patientView'),
        blurLabel: document.getElementById('blurLabel')
    };

    sturmUi.slider.addEventListener('input', updateSturm);

    function updateSturm() {
        // Patient has -3.00 Cyl (Intrinsic). 
        // Slider applies Correcting Cyl (e.g., -1.00, -2.00, -3.00).
        // Wait, normally we correct -3.00 cyl with -3.00 cyl lens? 
        // Let's say patient has Astigmatism of 3.00D.
        // Uncorrected = 3.00D Gap.
        // Full Correction = 0.00D Gap.
        
        let correction = parseFloat(sturmUi.slider.value); // -4.00 to 0.00
        // Target is to match the patient's error. Let's assume patient error is fixed -3.00.
        // So we need -3.00 to clear.
        // If slider is 0.00 -> Gap is 3.00.
        // If slider is -3.00 -> Gap is 0.00.
        
        // Let's interpret slider as "Cyl Power Added".
        // Patient Error: -3.00 D.
        // Net Error = Patient Error - Slider Value ? No.
        // Net Cyl = Patient (-3.00) - Correction.
        // Let's simplify: 
        // Gap = abs(3.00 + correction). 
        // Example: Slider -3.00 -> 3 + (-3) = 0. Great.
        // Example: Slider 0 -> 3 + 0 = 3.
        
        let targetCyl = -3.00; 
        let currentInput = correction; 
        let residual = Math.abs(targetCyl - currentInput); // e.g. |-3 - (-1)| = |-2| = 2.00 D gap.

        sturmUi.val.innerText = currentInput.toFixed(2);
        sturmUi.status.innerText = `Residual Astigmatism: ${residual.toFixed(2)} D`;

        // 1. Draw Sturm Conoid
        drawSturm(residual);

        // 2. Simulate Vision (Blur)
        // More residual = More blur
        // Max blur at 4.00 residual = 10px?
        let blurPx = residual * 2.5; 
        sturmUi.patientView.style.filter = `blur(${blurPx}px)`;
        
        if (residual < 0.25) {
            sturmUi.blurLabel.innerText = "Clear";
            sturmUi.blurLabel.style.color = "#16a34a";
        } else {
            sturmUi.blurLabel.innerText = "Blur";
            sturmUi.blurLabel.style.color = "#dc2626";
        }
    }

    function drawSturm(gap) {
        const cvs = document.getElementById('canvasSturm');
        const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2;
        const h = cvs.height = cvs.clientHeight * 2;
        ctx.scale(2, 2);
        ctx.clearRect(0,0,w,h);

        const cy = 90; 
        const lensX = 20;
        const retinaX = 280;

        // Gap determines distance between lines.
        // If gap=0, both at retinaX.
        // If gap=3, one at retinaX, one way in front? Or centered?
        // Let's assume CLC is on retina for "Mixed" look, or front line moves back.
        // For simplicity: Red Line is fixed (Sphere corrected), Blue line moves (Cyl).
        
        let redX = retinaX; // Fixed
        let blueX = retinaX - (gap * 40); // Moves left as gap increases

        // Draw Cone
        ctx.beginPath(); 
        ctx.moveTo(lensX, cy-30); ctx.lineTo(redX, cy);
        ctx.moveTo(lensX, cy+30); ctx.lineTo(redX, cy);
        ctx.strokeStyle = "rgba(220,38,38,0.5)"; ctx.stroke();

        ctx.beginPath(); 
        ctx.moveTo(lensX, cy-20); ctx.lineTo(blueX, cy);
        ctx.moveTo(lensX, cy+20); ctx.lineTo(blueX, cy);
        ctx.strokeStyle = "rgba(37,99,235,0.5)"; ctx.stroke();

        // Draw Lines
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(redX, cy-10); ctx.lineTo(redX, cy+10); 
        ctx.strokeStyle = "red"; ctx.stroke(); // Vertical focus

        ctx.beginPath(); ctx.moveTo(blueX, cy-10); ctx.lineTo(blueX, cy+10); 
        ctx.strokeStyle = "blue"; ctx.stroke(); // Horizontal focus
        
        // Draw CLC
        let clcX = (redX + blueX) / 2;
        ctx.beginPath(); ctx.arc(clcX, cy, 4, 0, Math.PI*2);
        ctx.fillStyle = "purple"; ctx.fill();
        ctx.font = "10px Arial"; ctx.fillText("CLC", clcX-10, cy-15);
    }

    // Init
    updateRayDiagram();
</script>
</body>
</html>
