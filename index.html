<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cikgu Astig Pro: Final</title>
    <style>
        :root { --primary: #0f766e; --accent: #0ea5e9; --bg: #f0fdfa; --text: #134e4a; --card: #ffffff; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- HEADER --- */
        .header { background: var(--primary); color: white; padding: 15px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 10; flex-shrink: 0; }
        .header h1 { margin: 0; font-size: 1.1rem; font-weight: 700; }
        .back-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 5px 12px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; display: none; }

        /* --- PAGES --- */
        .page { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .page.active { display: flex; flex-direction: column; gap: 15px; }

        /* --- DASHBOARD --- */
        #pageHome.active { justify-content: center; align-items: center; height: 100%; }
        .menu-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 15px; }
        .menu-card {
            background: var(--card); border: 1px solid #ccfbf1; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.1s;
            display: flex; align-items: center; gap: 15px; text-align: left;
        }
        .menu-card:active { transform: scale(0.98); background: #f0fdfa; }
        .menu-icon { width: 50px; height: 50px; background: #e0f2fe; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent); flex-shrink: 0; }
        
        /* --- UI COMPONENTS --- */
        .card { background: var(--card); padding: 15px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; width: 100%; box-sizing: border-box; }
        h3 { margin: 0 0 10px 0; font-size: 0.95rem; color: var(--primary); border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 10px; }
        input[type=range] { width: 100%; accent-color: var(--accent); }
        input[type=number] { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; width: 60px; text-align: center; }
        .result-box { background: #f8fafc; padding: 10px; border-radius: 8px; text-align: center; font-weight: bold; color: var(--primary); margin-top: 10px; border: 1px dashed #cbd5e1; }
        canvas { width: 100%; height: 200px; background: white; border-radius: 8px; border: 1px solid #e2e8f0; touch-action: none; }

        /* --- STURM PAGE (UPDATED) --- */
        /* Vertical Flex Layout */
        .sturm-container { display: flex; flex-direction: column; gap: 10px; height: 100%; }
        
        /* Top: Diagram (Lengthened) */
        .sturm-top { 
            flex: 2; /* Takes more space */
            background: #fff; border: 1px solid #ddd; border-radius: 8px; 
            position: relative; overflow: hidden; 
            min-height: 250px; /* Ensure height */
        }
        
        /* Bottom: Patient View */
        .sturm-bottom { 
            flex: 1; /* Less space */
            background: #000; border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden; position: relative;
            min-height: 120px;
        }
        
        .patient-img { font-size: 60px; color: white; font-family: serif; filter: blur(0px); transition: filter 0.1s; }
        
        /* Zoom Controls */
        .zoom-controls { position: absolute; bottom: 10px; left: 10px; display: flex; gap: 5px; }
        .zoom-btn { background: rgba(0,0,0,0.1); border: 1px solid #ccc; width: 30px; height: 30px; border-radius: 4px; cursor: pointer; font-weight: bold; color: #333; }
        .zoom-btn:active { background: #ddd; }

    </style>
</head>
<body>

    <div class="header">
        <button id="btnBack" class="back-btn">‚Üê Back</button>
        <h1 id="pageTitle">Cikgu Astig Pro</h1>
        <div style="width:50px;"></div>
    </div>

    <div id="pageHome" class="page active">
        <div class="menu-container">
            <div class="menu-card" onclick="nav('pageTransposition', 'Rx Calculator')">
                <div class="menu-icon">üßÆ</div>
                <div><h3>Transposition</h3><p>Rx & Optical Cross</p></div>
            </div>
            <div class="menu-card" onclick="nav('pageRay', 'Ray Diagram')">
                <div class="menu-icon">‚ö°</div>
                <div><h3>Simple Ray Model</h3><p>Focal Lines & Retina</p></div>
            </div>
            <div class="menu-card" onclick="nav('pageSturm', 'Interval of Sturm')">
                <div class="menu-icon">üéØ</div>
                <div><h3>Conoid Simulation</h3><p>Collapse to Point Focus</p></div>
            </div>
            <div class="card" style="margin-top:10px;">
                <h3>Patient Profile</h3>
                <div class="control-row"><label>Age:</label><input type="number" id="globalAge" value="25"></div>
            </div>
        </div>
    </div>

    <div id="pageTransposition" class="page">
        <div class="card">
            <h3>Input Prescription</h3>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="number" id="rxSph" placeholder="Sph" value="-2.00" step="0.25">
                <input type="number" id="rxCyl" placeholder="Cyl" value="-1.50" step="0.25">
                <input type="number" id="rxAxis" placeholder="Axis" value="180" step="1">
            </div>
            <button onclick="calcTransposition()" style="width:100%; padding:10px; background:var(--accent); color:white; border:none; border-radius:6px;">Calculate</button>
        </div>
        <div class="card">
            <h3>Results</h3>
            <div class="result-box"><div id="transposedRx" style="font-size:1.1rem;">-</div></div>
            <div class="result-box" style="background:#f0fdfa;"><div id="seVal">SE: -</div></div>
        </div>
        <div class="card" style="flex:1;">
            <h3>Optical Cross</h3>
            <canvas id="canvasCross"></canvas>
        </div>
    </div>

    <div id="pageRay" class="page">
        <canvas id="canvasRay" style="height:250px;"></canvas>
        <div class="result-box" id="astigType">Compound Myopic Astigmatism</div>
        <div class="card">
            <h3>Refractive Status</h3>
            <div class="control-row"><label style="color:#dc2626;">Vertical Power</label><input type="range" id="sliderSphRay" min="-6" max="6" step="0.25" value="-2.00"></div>
            <div class="control-row"><label style="color:#2563eb;">Horizontal Power</label><input type="range" id="sliderCylRay" min="-6" max="6" step="0.25" value="-4.00"></div>
        </div>
    </div>

    <div id="pageSturm" class="page">
        <div class="sturm-container">
            <div class="sturm-top">
                <canvas id="canvasSturm" style="width:100%; height:100%;"></canvas>
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomSturm(0.1)">+</button>
                    <button class="zoom-btn" onclick="zoomSturm(-0.1)">-</button>
                    <button class="zoom-btn" onclick="resetSturmCam()">‚Ü∫</button>
                </div>
            </div>
            <div class="sturm-bottom">
                <div id="patientView" class="patient-img">E</div>
            </div>
        </div>

        <div class="card">
            <h3>Correction Simulator</h3>
            <div class="control-row">
                <label>Correction</label>
                <span id="corrPct" style="font-weight:bold; color:#059669;">0%</span>
            </div>
            <input type="range" id="sliderCollapse" min="0" max="100" step="1" value="0">
            <div class="result-box" id="sturmStatus" style="font-size:0.9rem;">Interval: Wide</div>
        </div>
    </div>
<script>
    // --- NAV ---
    function nav(pageId, title) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.getElementById('pageTitle').innerText = title;
        document.getElementById('btnBack').style.display = 'block';
        if(pageId === 'pageTransposition') calcTransposition();
        if(pageId === 'pageRay') updateRayDiagram();
        if(pageId === 'pageSturm') updateSturm();
    }
    document.getElementById('btnBack').addEventListener('click', () => {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('pageHome').classList.add('active');
        document.getElementById('pageTitle').innerText = 'Cikgu Astig Pro';
        document.getElementById('btnBack').style.display = 'none';
    });

    // --- 1. TRANSPOSITION ---
    function calcTransposition() {
        let s = parseFloat(document.getElementById('rxSph').value);
        let c = parseFloat(document.getElementById('rxCyl').value);
        let a = parseInt(document.getElementById('rxAxis').value);
        let newS = s + c;
        let newC = -c;
        let newA = a > 90 ? a - 90 : a + 90;
        if (newA <= 0) newA += 180;
        let sign = newC > 0 ? "+" : "";
        document.getElementById('transposedRx').innerText = `${newS.toFixed(2)} / ${sign}${newC.toFixed(2)} x ${newA}`;
        let se = s + (c / 2);
        document.getElementById('seVal').innerText = `SE: ${(se > 0 ? "+" : "")}${se.toFixed(2)} D`;
        drawOpticalCross(s, c, a);
    }
    function drawOpticalCross(s, c, a) {
        const cvs = document.getElementById('canvasCross');
        const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2; const h = cvs.height = cvs.clientHeight * 2;
        ctx.scale(2, 2); ctx.clearRect(0,0,w,h);
        const cx = w/4, cy = h/4; let p1 = s, p2 = s+c;
        ctx.beginPath(); ctx.moveTo(cx, cy-60); ctx.lineTo(cx, cy+60);
        ctx.moveTo(cx-60, cy); ctx.lineTo(cx+60, cy);
        ctx.strokeStyle = "#334155"; ctx.lineWidth = 2; ctx.stroke();
        ctx.font = "14px Arial"; ctx.textAlign = "center";
        ctx.fillStyle = "#dc2626"; ctx.fillText((a===180?p2:p1).toFixed(2) + " D", cx, cy-70);
        ctx.fillStyle = "#2563eb"; ctx.fillText((a===180?p1:p2).toFixed(2) + " D", cx+70, cy);
    }

    // --- 2. RAY DIAGRAM ---
    const rayUi = { s: document.getElementById('sliderSphRay'), c: document.getElementById('sliderCylRay'), label: document.getElementById('astigType') };
    rayUi.s.addEventListener('input', updateRayDiagram); rayUi.c.addEventListener('input', updateRayDiagram);
    function updateRayDiagram() {
        let pV = parseFloat(rayUi.s.value); let pH = parseFloat(rayUi.c.value);
        let type = "Mixed";
        if(pV > 0 && pH > 0) type = "Compound Myopic";
        else if(pV < 0 && pH < 0) type = "Compound Hyperopic";
        else if(pV === 0 && pH === 0) type = "Emmetropia";
        else if(pV === 0 || pH === 0) type = "Simple " + (pV+pH > 0 ? "Myopic" : "Hyperopic");
        rayUi.label.innerText = type;
        drawSimpleRays(pV, pH);
    }
    function drawSimpleRays(pRed, pBlue) {
        const cvs = document.getElementById('canvasRay'); const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2; const h = cvs.height = cvs.clientHeight * 2;
        ctx.scale(2, 2); ctx.clearRect(0,0,w,h);
        const cy = 110; const retinaX = 300; const lensX = 50;
        
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(w, cy);
        ctx.strokeStyle = "#e2e8f0"; ctx.lineWidth = 1; ctx.stroke();
        
        ctx.beginPath(); ctx.moveTo(retinaX, cy-80); ctx.lineTo(retinaX, cy+80);
        ctx.strokeStyle = "#0f172a"; ctx.lineWidth = 3; ctx.stroke();
        ctx.fillStyle = "#0f172a"; ctx.font = "12px sans-serif"; ctx.fillText("Retina", retinaX-20, cy-90);
        
        let xRed = retinaX - (pRed * 30); let xBlue = retinaX - (pBlue * 30);
        
        ctx.beginPath(); ctx.moveTo(lensX, cy-30); ctx.lineTo(xRed, cy); ctx.moveTo(lensX, cy+30); ctx.lineTo(xRed, cy);
        ctx.strokeStyle = "rgba(220, 38, 38, 0.6)"; ctx.lineWidth = 2; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(xRed, cy-15); ctx.lineTo(xRed, cy+15); ctx.strokeStyle = "red"; ctx.lineWidth = 3; ctx.stroke();
        
        ctx.beginPath(); ctx.moveTo(lensX, cy-20); ctx.lineTo(xBlue, cy); ctx.moveTo(lensX, cy+20); ctx.lineTo(xBlue, cy);
        ctx.strokeStyle = "rgba(37, 99, 235, 0.6)"; ctx.lineWidth = 2; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(xBlue, cy-10); ctx.lineTo(xBlue, cy+10); ctx.strokeStyle = "blue"; ctx.lineWidth = 3; ctx.stroke();
        
        ctx.beginPath(); ctx.moveTo(xRed, cy+25); ctx.lineTo(xBlue, cy+25);
        ctx.strokeStyle = "#64748b"; ctx.setLineDash([5,5]); ctx.stroke(); ctx.setLineDash([]);
        ctx.fillText("Interval", (xRed+xBlue)/2 - 20, cy+40);
    }

    // --- 3. STURM CONOID ---
    const sturmUi = { slider: document.getElementById('sliderCollapse'), pct: document.getElementById('corrPct'), status: document.getElementById('sturmStatus'), patient: document.getElementById('patientView') };
    let sturmCam = { x: 0, y: 0, z: 1.0 }; let isDragging = false; let lastX = 0;
    sturmUi.slider.addEventListener('input', updateSturm);
    function zoomSturm(amount) { sturmCam.z += amount; if(sturmCam.z < 0.5) sturmCam.z=0.5; if(sturmCam.z > 3.0) sturmCam.z=3.0; updateSturm(); }
    function resetSturmCam() { sturmCam = {x:0, y:0, z:1.0}; updateSturm(); }
    const sc = document.getElementById('canvasSturm');
    sc.addEventListener('pointerdown', e => { isDragging=true; lastX=e.clientX; sc.setPointerCapture(e.pointerId); });
    sc.addEventListener('pointermove', e => { if(!isDragging)return; sturmCam.x += (e.clientX-lastX); lastX=e.clientX; updateSturm(); });
    sc.addEventListener('pointerup', e => { isDragging=false; });

    function updateSturm() {
        let pct = parseInt(sturmUi.slider.value);
        sturmUi.pct.innerText = pct + "%";
        
        let maxGapPx = 160; 
        let currentGap = maxGapPx * (1 - pct/100);
        let retinaX = 300; 
        let redX = retinaX - (currentGap / 2);
        let blueX = retinaX + (currentGap / 2);
        let clcX = retinaX; 
        let clcRadius = (currentGap / 15); // Smaller CoLC

        let blurAmount = currentGap / 20;
        sturmUi.patient.style.filter = `blur(${blurAmount}px)`;
        
        if(pct === 100) {
            sturmUi.status.innerText = "Status: Fully Corrected (Point Focus)";
            sturmUi.status.style.color = "#16a34a";
        } else {
            sturmUi.status.innerText = "Status: Astigmatic Blur";
            sturmUi.status.style.color = "#dc2626";
        }

        drawSturmScene(redX, blueX, clcX, clcRadius, pct);
    }

    function drawSturmScene(rx, bx, cx, cr, pct) {
        const cvs = document.getElementById('canvasSturm'); const ctx = cvs.getContext('2d');
        const w = cvs.width = cvs.clientWidth * 2; const h = cvs.height = cvs.clientHeight * 2;
        ctx.resetTransform(); ctx.scale(2, 2); ctx.clearRect(0,0,w/2, h/2);
        
        ctx.save(); ctx.translate(sturmCam.x, 0); ctx.scale(sturmCam.z, sturmCam.z);
        const cy = 130; const lensX = 50;

        // Optical Axis
        ctx.beginPath(); ctx.moveTo(0, cy); ctx.lineTo(600, cy);
        ctx.strokeStyle = "#cbd5e1"; ctx.stroke();

        // Lens Cone Guide
        ctx.beginPath(); ctx.moveTo(lensX, cy-40); ctx.lineTo(rx, cy); ctx.lineTo(600, cy+((600-rx)/(rx-lensX)*40));
        ctx.strokeStyle = "rgba(220,38,38,0.1)"; ctx.stroke();
        ctx.beginPath(); ctx.moveTo(lensX, cy-30); ctx.lineTo(bx, cy);
        ctx.strokeStyle = "rgba(37,99,235,0.1)"; ctx.stroke();

        // *** LOGIC: IF 100% CORRECTED, DRAW ONE POINT ***
        if (pct >= 99) {
            // Draw Single Point
            ctx.beginPath(); ctx.arc(cx, cy, 4, 0, Math.PI*2);
            ctx.fillStyle = "#16a34a"; ctx.fill(); // Green point
            ctx.fillStyle = "#16a34a"; ctx.font = "bold 12px Arial"; ctx.fillText("Point Focus", cx-30, cy-15);
        } else {
            // Draw Separate Lines
            // 1. Red Line (Vertical)
            ctx.beginPath(); ctx.moveTo(rx, cy-20); ctx.lineTo(rx, cy+20);
            ctx.strokeStyle = "red"; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = "red"; ctx.fillText("V", rx-5, cy-25);

            // 2. Blue Line (Horizontal) - Drawn horizontally
            ctx.beginPath(); ctx.moveTo(bx-20, cy); ctx.lineTo(bx+20, cy);
            ctx.strokeStyle = "blue"; ctx.lineWidth = 3; ctx.stroke();
            ctx.fillStyle = "blue"; ctx.fillText("H", bx-5, cy-10);

            // 3. CoLC (Midpoint) - Smaller
            ctx.beginPath(); ctx.arc(cx, cy, Math.max(2, cr), 0, Math.PI*2);
            ctx.fillStyle = "rgba(128, 0, 128, 0.4)"; ctx.fill();
            ctx.strokeStyle = "purple"; ctx.lineWidth = 1; ctx.stroke();
            ctx.fillStyle = "purple"; ctx.font = "10px Arial"; ctx.fillText("CLC", cx-10, cy+cr+15);
        }
        
        // Retina Marker
        ctx.beginPath(); ctx.moveTo(cx, cy-60); ctx.lineTo(cx, cy+60);
        ctx.strokeStyle = "#333"; ctx.lineWidth = 1; ctx.setLineDash([2,2]); ctx.stroke();
        ctx.fillStyle = "#333"; ctx.fillText("Retina", cx-15, cy+70);

        ctx.restore();
    }
</script>
</body>
</html>
